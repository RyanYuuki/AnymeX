name: Update CodeFactor Badge

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-badge:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Fetch the current grade from CodeFactor
      - name: Fetch CodeFactor Grade
        id: fetch-grade
        run: |
          RESPONSE=$(curl -s 'https://www.codefactor.io/repository/github/ryanyuuki/anymex/badge')
          echo "Response from CodeFactor: $RESPONSE"
          
          # Extract the grade using sed
          GRADE=$(echo "$RESPONSE" | sed -n 's/.*grade-\([A-F]\).*/\1/p')
          
          if [ -z "$GRADE" ]; then
            echo "Failed to extract CodeFactor grade. Exiting."
            exit 1
          fi
          
          echo "GRADE=$GRADE" >> $GITHUB_ENV

      # Step 3: Set dynamic color based on grade
      - name: Set Dynamic Badge Color
        run: |
          # Determine the badge color based on the grade
          if [ "$GRADE" == "A" ]; then
            COLOR="brightgreen"
          elif [ "$GRADE" == "B" ]; then
            COLOR="green"
          elif [ "$GRADE" == "C" ]; then
            COLOR="yellowgreen"
          elif [ "$GRADE" == "D" ]; then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          
          # Create a badge JSON with the grade and dynamic color
          echo "{
            \"schemaVersion\": 1,
            \"label\": \"CodeFactor\",
            \"message\": \"$GRADE\",
            \"color\": \"$COLOR\"
          }" > badges/badge.json

      # Step 4: Commit the badge update to the repository
      - name: Commit Badge
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add badges/badge.json
          git commit -m "Update CodeFactor badge with dynamic color"
          git push
