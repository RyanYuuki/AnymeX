name: Build Android APKs (Manual Beta)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (e.g., v1.0.0+1-beta)'
        required: true
        type: string

env:
  FLUTTER_VERSION: "3.32.8"

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - uses: actions/setup-java@v3
        with:
          distribution: "adopt"
          java-version: "17"
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: false
      
      - name: Apply Beta Configuration
        shell: bash
        run: |
          TAG="${{ inputs.tag }}"

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  MANUAL BETA BUILD"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Input tag: $TAG"
          echo ""

          # Extract version part (remove v)
          # v3.0.4-beta â†’ 3.0.4-beta
          # v3.0.4+1-beta â†’ 3.0.4+1-beta
          VERSION_PART=$(echo "$TAG" | sed 's/^v//')

          echo "Display version: v$VERSION_PART"

          # For pubspec.yaml, we need only semver (before any +)
          # 3.0.4+1-beta â†’ 3.0.4
          # 3.0.4-beta â†’ 3.0.4
          if [[ "$VERSION_PART" == *"+"* ]]; then
            SEMVER=$(echo "$VERSION_PART" | cut -d'+' -f1 | cut -d'-' -f1)
          else
            SEMVER=$(echo "$VERSION_PART" | cut -d'-' -f1)
          fi

          echo "Semver: $SEMVER"

          # GitHub build number
          BUILD_NUMBER="${GITHUB_RUN_NUMBER}"

          # pubspec.yaml version (valid Flutter format)
          PUBSPEC_VERSION="${SEMVER}+${BUILD_NUMBER}"

          # Display version is just tag without v (no build number)
          DISPLAY_VERSION="v${VERSION_PART}"

          echo "Pubspec version: $PUBSPEC_VERSION"
          echo "Display version: $DISPLAY_VERSION"
          echo ""

          # Check if rename script exists
          if [ ! -f "scripts/rename_app.sh" ]; then
            echo "âŒ Error: scripts/rename_app.sh not found"
            exit 1
          fi

          # Make script executable and run
          chmod +x scripts/rename_app.sh
          echo "Running rename script..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if ./scripts/rename_app.sh "$PUBSPEC_VERSION" "$DISPLAY_VERSION"; then
            echo ""
            echo "âœ… Beta rename completed successfully"
            echo "   Package: com.ryan.anymex â†’ com.ryan.anymexbeta"
            echo "   App Name: AnymeX â†’ AnymeX Î²"
            echo "   Pubspec Version: $PUBSPEC_VERSION"
            echo "   Display Version: $DISPLAY_VERSION"
          else
            echo ""
            echo "âŒ Beta rename failed"
            exit 1
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # =================================================================
      # Disable Google Services for beta builds
      # =================================================================
      - name: Disable Google Services for Beta
        shell: bash
        run: |
          echo "ðŸ”µ Disabling Google Services for Beta Build"
          
          # Remove google-services plugin from app/build.gradle
          if [ -f "android/app/build.gradle" ]; then
            echo "Modifying android/app/build.gradle..."
            sed -i '/com\.google\.gms\.google-services/d' android/app/build.gradle
            echo "âœ… Removed google-services plugin from app/build.gradle"
          fi
          
          # Remove google-services classpath from build.gradle
          if [ -f "android/build.gradle" ]; then
            echo "Modifying android/build.gradle..."
            sed -i '/com\.google\.gms:google-services:/d' android/build.gradle
            echo "âœ… Removed google-services classpath from build.gradle"
          fi
          
          # Verify changes
          echo ""
          echo "Verification - checking for remaining google-services references:"
          grep -n "google-services" android/app/build.gradle android/build.gradle || echo "âœ… No google-services references found"

      - name: Verify Beta Configuration
        shell: bash
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Verifying Beta Configuration"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          ERRORS=0

          # ==========================================
          # DART CODE
          # ==========================================
          echo ""
          echo "ðŸŽ¯ DART"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          if grep -q 'title: "AnymeX Î²"' lib/main.dart 2>/dev/null; then
            echo "âœ… MaterialApp title in lib/main.dart"
          else
            echo "âŒ MaterialApp title NOT updated in lib/main.dart"
            ERRORS=$((ERRORS + 1))
          fi

          # ==========================================
          # ANDROID
          # ==========================================
          echo ""
          echo "ðŸ“± ANDROID"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          if grep -q "com.ryan.anymexbeta" android/app/build.gradle* 2>/dev/null; then
            echo "âœ… Package name in build.gradle"
          else
            echo "âŒ Package name NOT updated in build.gradle"
            ERRORS=$((ERRORS + 1))
          fi

          if grep -q 'package="com.ryan.anymexbeta"' android/app/src/main/AndroidManifest.xml 2>/dev/null; then
            echo "âœ… Package in AndroidManifest.xml"
          else
            echo "âŒ Package NOT updated in AndroidManifest.xml"
            ERRORS=$((ERRORS + 1))
          fi

          if grep -q 'android:label="AnymeX Î²"' android/app/src/main/AndroidManifest.xml 2>/dev/null; then
            echo "âœ… App name in AndroidManifest.xml"
          else
            echo "âŒ App name NOT updated in AndroidManifest.xml"
            ERRORS=$((ERRORS + 1))
          fi

          if [ -d "android/app/src/main/kotlin/com/ryan/anymexbeta" ]; then
            echo "âœ… Kotlin package directory moved"
          else
            echo "âŒ Kotlin package directory NOT found"
            ERRORS=$((ERRORS + 1))
          fi

          if [ -d "android/app/src/main/kotlin/com/ryan/anymexbeta" ]; then
            if grep -q "package com.ryan.anymexbeta" android/app/src/main/kotlin/com/ryan/anymexbeta/*.kt 2>/dev/null; then
              echo "âœ… Kotlin files package declaration"
            else
              echo "âŒ Kotlin package declaration NOT updated"
              ERRORS=$((ERRORS + 1))
            fi
          fi

          # ==========================================
          # Flutter pubspec.yaml
          # ==========================================
          echo ""
          echo "ðŸŽ¯ FLUTTER"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          TAG="${{ inputs.tag }}"
          VERSION_PART=$(echo "$TAG" | sed 's/^v//')
          if [[ "$VERSION_PART" == *"+"* ]]; then
            SEMVER=$(echo "$VERSION_PART" | cut -d'+' -f1 | cut -d'-' -f1)
          else
            SEMVER=$(echo "$VERSION_PART" | cut -d'-' -f1)
          fi
          BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
          VERSION="${SEMVER}+${BUILD_NUMBER}"

          if grep -q "version: $VERSION" pubspec.yaml 2>/dev/null; then
            echo "âœ… Version updated in pubspec.yaml: $VERSION"
          else
            echo "âŒ Version NOT updated in pubspec.yaml"
            echo "   Expected: version: $VERSION"
            echo "   Found:"
            grep "^version:" pubspec.yaml 2>/dev/null || echo "   No version line found"
            ERRORS=$((ERRORS + 1))
          fi

          # ==========================================
          # Summary
          # ==========================================
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ $ERRORS -eq 0 ]; then
            echo "âœ… ANDROID VERIFIED SUCCESSFULLY"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 0
          else
            echo "âŒ VERIFICATION FAILED: $ERRORS error(s) found"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
      
      - name: Cache CMake
        uses: actions/cache@v3
        with:
          path: ~/cmake
          key: cmake-3.18.1-linux-x64
      
      - name: Setup Android
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          if [ ! -d "$HOME/cmake/cmake-3.18.1-Linux-x86_64" ]; then
            mkdir -p $HOME/cmake && cd $HOME/cmake
            wget -q https://github.com/Kitware/CMake/releases/download/v3.18.1/cmake-3.18.1-Linux-x86_64.tar.gz
            tar -xzf cmake-3.18.1-Linux-x86_64.tar.gz
          fi
          cd $GITHUB_WORKSPACE
          CMAKE_DIR="$HOME/cmake/cmake-3.18.1-Linux-x86_64"
          echo "cmake.dir=$CMAKE_DIR" >> android/local.properties
          mkdir -p android/app
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/anymex.jks
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=anymex.jks
          EOF
      
      - name: Setup Environment
        shell: bash
        env:
          AL_CLIENT_ID: ${{ secrets.AL_CLIENT_ID }}
          AL_CLIENT_SECRET: ${{ secrets.AL_CLIENT_SECRET }}
          SIMKL_CLIENT_ID: ${{ secrets.SIMKL_CLIENT_ID }}
          SIMKL_CLIENT_SECRET: ${{ secrets.SIMKL_CLIENT_SECRET }}
          MAL_CLIENT_ID: ${{ secrets.MAL_CLIENT_ID }}
          MAL_CLIENT_SECRET: ${{ secrets.MAL_CLIENT_SECRET }}
          CALLBACK_SCHEME: ${{ secrets.CALLBACK_SCHEME }}
          GOOGLE_BOOKS_API_KEY: ${{ secrets.GOOGLE_BOOKS_API_KEY }}
        run: |
          cat > .env << EOF
          AL_CLIENT_ID=$AL_CLIENT_ID
          AL_CLIENT_SECRET=$AL_CLIENT_SECRET
          SIMKL_CLIENT_ID=$SIMKL_CLIENT_ID
          SIMKL_CLIENT_SECRET=$SIMKL_CLIENT_SECRET
          MAL_CLIENT_ID=$MAL_CLIENT_ID
          MAL_CLIENT_SECRET=$MAL_CLIENT_SECRET
          CALLBACK_SCHEME=$CALLBACK_SCHEME
          GOOGLE_BOOKS_API_KEY=$GOOGLE_BOOKS_API_KEY
          EOF
      
      - name: Clean Flutter
        run: flutter clean
      
      - name: Build Android APKs
        run: |
          flutter pub get
          flutter build apk --split-per-abi
          flutter build apk --release
          
      - name: Rename APKs
        run: |
          cd build/app/outputs/flutter-apk
          mv app-armeabi-v7a-release.apk AnymeX-Android-armeabi-v7a.apk
          mv app-arm64-v8a-release.apk AnymeX-Android-arm64-v8a.apk
          mv app-x86_64-release.apk AnymeX-Android-x86_64.apk
          mv app-release.apk AnymeX-Android-universal.apk
      
      # =================================================================
      # Upload each APK as a separate artifact
      # =================================================================
      - name: Upload APK (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64-v8a
          path: build/app/outputs/flutter-apk/AnymeX-Android-arm64-v8a.apk
      
      - name: Upload APK (armeabi-v7a)
        uses: actions/upload-artifact@v4
        with:
          name: android-armeabi-v7a
          path: build/app/outputs/flutter-apk/AnymeX-Android-armeabi-v7a.apk
      
      - name: Upload APK (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: android-x86_64
          path: build/app/outputs/flutter-apk/AnymeX-Android-x86_64.apk
      
      - name: Upload APK (universal)
        uses: actions/upload-artifact@v4
        with:
          name: android-universal
          path: build/app/outputs/flutter-apk/AnymeX-Android-universal.apk
