name: Update Changelog

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install -g conventional-changelog-cli

      - name: Generate CHANGELOG.md
        run: |
          conventional-changelog -p angular -i CHANGELOG.md -s -r 0

      - name: Generate Plaintext Changelog for F-Droid/Izzy
        run: |
          mkdir -p fastlane/metadata/android/en-US/changelogs
          # Extract latest release notes only from CHANGELOG.md
          awk '/^## /{if (c++) exit} {print}' CHANGELOG.md \
            | sed -E 's/^###* //g; s/!\[[^]]*\]\([^)]*\)//g; s/\[[^]]*\]\([^)]*\)//g; s/^[[:space:]]*//g' \
            | grep -v "TOTAL DOWNLOADS" \
            | grep -v "CURRENT RELEASE" \
            | sed 's/^֍[[:space:]]*/- /' \
            | sed '/^$/N;/^\n$/D' \
            > fastlane/metadata/android/en-US/changelogs/default.txt

      - name: Debug default.txt
        run: cat fastlane/metadata/android/en-US/changelogs/default.txt

      - name: Commit and Push Changelog
        env:
          current_tag: ${{ github.ref_name }}
        run: |
          git config --global user.name "Git Paneer"
          git config --global user.email "actions@github.com"
          git add CHANGELOG.md fastlane/metadata/android/en-US/changelogs/default.txt
          git commit --allow-empty -m "Update changelogs for version $current_tag"
          git push origin HEAD:main
